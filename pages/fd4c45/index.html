<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>yolov5网络详解 | Liuyuan&#39;s blog</title>
    <meta name="generator" content="VuePress 1.9.5">
    <link rel="icon" href="/img/favicon.ico">
    <meta name="description" content="个人博客。">
    <meta name="keywords" content="个人博客。">
    <meta name="baidu-site-verification" content="7F55weZDDc">
    <meta name="theme-color" content="#11a8cd">
    
    <link rel="preload" href="/assets/css/0.styles.6b291d34.css" as="style"><link rel="preload" href="/assets/js/app.50fadf31.js" as="script"><link rel="preload" href="/assets/js/2.47a03fa1.js" as="script"><link rel="preload" href="/assets/js/3.436c0527.js" as="script"><link rel="preload" href="/assets/js/41.0b9b9a66.js" as="script"><link rel="prefetch" href="/assets/js/10.a34e71ca.js"><link rel="prefetch" href="/assets/js/11.97b02391.js"><link rel="prefetch" href="/assets/js/12.8e6e4c4b.js"><link rel="prefetch" href="/assets/js/13.00db5453.js"><link rel="prefetch" href="/assets/js/14.e91dd435.js"><link rel="prefetch" href="/assets/js/15.6018daa8.js"><link rel="prefetch" href="/assets/js/16.d7372590.js"><link rel="prefetch" href="/assets/js/17.d89a4381.js"><link rel="prefetch" href="/assets/js/18.ea92a9c3.js"><link rel="prefetch" href="/assets/js/19.825ba7c0.js"><link rel="prefetch" href="/assets/js/20.8330b139.js"><link rel="prefetch" href="/assets/js/21.e65d87fa.js"><link rel="prefetch" href="/assets/js/22.84ef7201.js"><link rel="prefetch" href="/assets/js/23.c4c00f09.js"><link rel="prefetch" href="/assets/js/24.1474c794.js"><link rel="prefetch" href="/assets/js/25.607370fa.js"><link rel="prefetch" href="/assets/js/26.85790132.js"><link rel="prefetch" href="/assets/js/27.251cd882.js"><link rel="prefetch" href="/assets/js/28.87d9bae7.js"><link rel="prefetch" href="/assets/js/29.59230516.js"><link rel="prefetch" href="/assets/js/30.515bed4d.js"><link rel="prefetch" href="/assets/js/31.6eac8e06.js"><link rel="prefetch" href="/assets/js/32.e79b26fb.js"><link rel="prefetch" href="/assets/js/33.eee2be0d.js"><link rel="prefetch" href="/assets/js/34.22836300.js"><link rel="prefetch" href="/assets/js/35.1bb64409.js"><link rel="prefetch" href="/assets/js/36.7fb27be9.js"><link rel="prefetch" href="/assets/js/37.54e1ee25.js"><link rel="prefetch" href="/assets/js/38.e1fd2084.js"><link rel="prefetch" href="/assets/js/39.aa56611a.js"><link rel="prefetch" href="/assets/js/4.54ba375b.js"><link rel="prefetch" href="/assets/js/40.ae81606b.js"><link rel="prefetch" href="/assets/js/42.1ac387fb.js"><link rel="prefetch" href="/assets/js/43.5ce9c58b.js"><link rel="prefetch" href="/assets/js/44.750f46f0.js"><link rel="prefetch" href="/assets/js/45.d92dc275.js"><link rel="prefetch" href="/assets/js/46.22138ea3.js"><link rel="prefetch" href="/assets/js/47.c5cd0fb4.js"><link rel="prefetch" href="/assets/js/48.a6b8db9f.js"><link rel="prefetch" href="/assets/js/49.5be7f37d.js"><link rel="prefetch" href="/assets/js/5.7e641334.js"><link rel="prefetch" href="/assets/js/50.3bbc1ed4.js"><link rel="prefetch" href="/assets/js/51.69439a8b.js"><link rel="prefetch" href="/assets/js/52.6765e0d8.js"><link rel="prefetch" href="/assets/js/53.b7f818bd.js"><link rel="prefetch" href="/assets/js/54.fa6416de.js"><link rel="prefetch" href="/assets/js/55.14d3b063.js"><link rel="prefetch" href="/assets/js/56.8db2a655.js"><link rel="prefetch" href="/assets/js/57.2c520b79.js"><link rel="prefetch" href="/assets/js/58.926c69a8.js"><link rel="prefetch" href="/assets/js/59.303cfc72.js"><link rel="prefetch" href="/assets/js/6.40ea68d2.js"><link rel="prefetch" href="/assets/js/7.86d54bc0.js"><link rel="prefetch" href="/assets/js/8.fe46a857.js"><link rel="prefetch" href="/assets/js/9.dc879685.js">
    <link rel="stylesheet" href="/assets/css/0.styles.6b291d34.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/logo.png" alt="Liuyuan's blog" class="logo"> <span class="site-name can-hide">Liuyuan's blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="/research/" class="nav-link">学术搬砖</a></div><div class="nav-item"><a href="/notes/" class="nav-link">学习笔记</a></div><div class="nav-item"><a href="/life/" class="nav-link">生活杂谈</a></div><div class="nav-item"><a href="/blog/" class="nav-link">blog搬运</a></div><div class="nav-item"><a href="/about/" class="nav-link">关于</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div> <a href="https://github.com/my-monster/blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src="/img/myself.jpg"> <div class="blogger-info"><h3>Liu Yuan</h3> <span>热爱生活！</span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="/research/" class="nav-link">学术搬砖</a></div><div class="nav-item"><a href="/notes/" class="nav-link">学习笔记</a></div><div class="nav-item"><a href="/life/" class="nav-link">生活杂谈</a></div><div class="nav-item"><a href="/blog/" class="nav-link">blog搬运</a></div><div class="nav-item"><a href="/about/" class="nav-link">关于</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div> <a href="https://github.com/my-monster/blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>OpenCV</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>通用框架-mmlab系列</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>ImageJ插件</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>图像（医学影像）基础</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>损失函数</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>yolov5学习</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/984f87/" class="sidebar-link">yolov5 数据增强详解</a></li><li><a href="/pages/919400/" class="sidebar-link">yolov5-backbone网络细节</a></li><li><a href="/pages/b8eb07/" class="sidebar-link">yolov5-边框预测公式及代码讲解</a></li><li><a href="/pages/ad0ee4/" class="sidebar-link">yolov5-损失计算 box loss</a></li><li><a href="/pages/b544fb/" class="sidebar-link">yolov5-源码数据处理解析</a></li><li><a href="/pages/fd4c45/" aria-current="page" class="active sidebar-link">yolov5网络详解</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level2"><a href="/pages/fd4c45/#_1-1-backbone" class="sidebar-link">1.1 Backbone</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/fd4c45/#_1-focus结构" class="sidebar-link">（1）Focus结构</a></li><li class="sidebar-sub-header level3"><a href="/pages/fd4c45/#_2-new-csp-darknet53" class="sidebar-link">（2）New CSP-Darknet53</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/fd4c45/#_1-2-neck" class="sidebar-link">1.2 Neck</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/fd4c45/#_1-fpn-pan" class="sidebar-link">（1）FPN+PAN</a></li><li class="sidebar-sub-header level3"><a href="/pages/fd4c45/#_2-sppf" class="sidebar-link">（2）SPPF</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/fd4c45/#_1-3-prediction" class="sidebar-link">1.3 Prediction</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/fd4c45/#_1-ciou-loss" class="sidebar-link">（1）CIOU_loss</a></li><li class="sidebar-sub-header level4"><a href="/pages/fd4c45/#a-iou-loss" class="sidebar-link">a.IOU_Loss</a></li><li class="sidebar-sub-header level4"><a href="/pages/fd4c45/#b-giou-loss" class="sidebar-link">b.GIOU_Loss</a></li><li class="sidebar-sub-header level4"><a href="/pages/fd4c45/#c-diou-loss" class="sidebar-link">c.DIOU_Loss</a></li><li class="sidebar-sub-header level4"><a href="/pages/fd4c45/#d-ciou-loss" class="sidebar-link">d.CIOU_Loss</a></li><li class="sidebar-sub-header level3"><a href="/pages/fd4c45/#_2-diou-nms" class="sidebar-link">(2) DIOU_nms</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/fd4c45/#_2-数据增强" class="sidebar-link">2 数据增强</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/fd4c45/#_1-对原图做数据增强" class="sidebar-link">1. 对原图做数据增强</a></li><li class="sidebar-sub-header level3"><a href="/pages/fd4c45/#_2-对标签做同样的增强" class="sidebar-link">2. 对标签做同样的增强</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/fd4c45/#_3-输入端优化" class="sidebar-link">3 输入端优化</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/fd4c45/#_3-1自适应锚框计算" class="sidebar-link">3.1自适应锚框计算</a></li><li class="sidebar-sub-header level3"><a href="/pages/fd4c45/#_3-2自适应图片缩放" class="sidebar-link">3.2自适应图片缩放</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/fd4c45/#_3-yolov5四种网络结构的不同点" class="sidebar-link">3 Yolov5四种网络结构的不同点</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/fd4c45/#_3-1-四种结构的参数" class="sidebar-link">3.1 四种结构的参数</a></li><li class="sidebar-sub-header level4"><a href="/pages/fd4c45/#_1-yolov5s-yaml" class="sidebar-link">（1）Yolov5s.yaml</a></li><li class="sidebar-sub-header level4"><a href="/pages/fd4c45/#_2-yolov5m-yaml" class="sidebar-link">（2）Yolov5m.yaml</a></li><li class="sidebar-sub-header level4"><a href="/pages/fd4c45/#_3-yolov5l-yaml" class="sidebar-link">（3）Yolov5l.yaml</a></li><li class="sidebar-sub-header level4"><a href="/pages/fd4c45/#_4-yolov5x-yaml" class="sidebar-link">（4）Yolov5x.yaml</a></li><li class="sidebar-sub-header level3"><a href="/pages/fd4c45/#_3-2-yolov5网络结构" class="sidebar-link">3.2 Yolov5网络结构</a></li><li class="sidebar-sub-header level3"><a href="/pages/fd4c45/#_3-3-yolov5四种网络的深度" class="sidebar-link">3.3 Yolov5四种网络的深度</a></li><li class="sidebar-sub-header level4"><a href="/pages/fd4c45/#_1-不同网络的深度" class="sidebar-link">（1）不同网络的深度</a></li><li class="sidebar-sub-header level4"><a href="/pages/fd4c45/#_2-控制深度的代码" class="sidebar-link">（2）控制深度的代码</a></li><li class="sidebar-sub-header level4"><a href="/pages/fd4c45/#_3-验证控制深度的有效性" class="sidebar-link">（3）验证控制深度的有效性</a></li><li class="sidebar-sub-header level5"><a href="/pages/fd4c45/#a-yolov5s-yaml" class="sidebar-link">a. yolov5s.yaml</a></li><li class="sidebar-sub-header level5"><a href="/pages/fd4c45/#b-yolov5l-xml" class="sidebar-link">b. yolov5l.xml</a></li><li class="sidebar-sub-header level3"><a href="/pages/fd4c45/#_3-4-yolov5四种网络的宽度" class="sidebar-link">3.4 Yolov5四种网络的宽度</a></li><li class="sidebar-sub-header level4"><a href="/pages/fd4c45/#_1-不同网络的宽度" class="sidebar-link">（1）不同网络的宽度:</a></li><li class="sidebar-sub-header level4"><a href="/pages/fd4c45/#_2-控制宽度的代码" class="sidebar-link">（2）控制宽度的代码</a></li><li class="sidebar-sub-header level4"><a href="/pages/fd4c45/#_3-验证控制宽度的有效性" class="sidebar-link">（3）验证控制宽度的有效性</a></li><li class="sidebar-sub-header level4"><a href="/pages/fd4c45/#a-yolov5s-yaml-2" class="sidebar-link">a. yolov5s.yaml</a></li><li class="sidebar-sub-header level4"><a href="/pages/fd4c45/#b-yolov5l-yaml" class="sidebar-link">b. yolov5l.yaml</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/fd4c45/#参考" class="sidebar-link">参考：</a></li></ul></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Python基础</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-5add8e0a><div class="articleInfo" data-v-5add8e0a><ul class="breadcrumbs" data-v-5add8e0a><li data-v-5add8e0a><a href="/" title="首页" class="iconfont icon-home router-link-active" data-v-5add8e0a></a></li> <li data-v-5add8e0a><a href="/notes/#学习笔记" data-v-5add8e0a>学习笔记</a></li><li data-v-5add8e0a><a href="/notes/#yolov5学习" data-v-5add8e0a>yolov5学习</a></li></ul> <div class="info" data-v-5add8e0a><div title="作者" class="author iconfont icon-touxiang" data-v-5add8e0a><a href="https://github.com/my-monster" target="_blank" title="作者" class="beLink" data-v-5add8e0a>liuyuan</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-5add8e0a><a href="javascript:;" data-v-5add8e0a>2023-03-13</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">目录</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABGpJREFUSA3tVVtoXFUU3fvOI53UlmCaKIFmwEhsE7QK0ipFEdHEKpXaZGrp15SINsXUWvBDpBgQRKi0+KKoFeJHfZA+ED9KKoIU2gYD9UejTW4rVIzm0VSTziPzuNu1z507dibTTjL4U/DAzLn3nL3X2o91ziX6f9wMFdh6Jvbm9nNSV0msViVO6tN1Rm7NMu2OpeJ9lWBUTDxrJbYTS0hInuwciu9eLHlFxCLCZEk3MegsJmZ5K/JD6t7FkFdEvGUo1g7qJoG3MHImqRIn8/nzY1K9UPKKiJmtnUqHVE3Gbuay6vJE/N2FEmuxFjW2nUuE0yQXRRxLiTUAzs36zhZvOXJPdX850EVnnLZkB8prodQoM5JGj7Xk2mvC7JB8tG04Ef5PiXtG0UtxupRQSfTnBoCy554x18yJHI6I+G5Eru4LHmPJZEQsrvPUbMiA8G/WgMK7w7I+ez7++o2ANfbrjvaOl1tFMs+htG3IrZH9/hDX1Pr8Tc0UvH8tcX29KzAgIGcEkINyW5BF9x891hw6VYqgJHEk0huccS7vh3C6gTiODL+26huuBtbct8eZnqLML8PkxGYpuPZBqtqwkSjgc4mB5gbgig5i+y0UDK35LMxXisn9xQtK+nd26gTIHsHe/oblK/b29fUmN/8Y+9jAQrnBp56m1LcDlDp9irKTExSKduXJVWSqdBMA08pEJnEIOB3FPPMybu/oeV8zFeYN3xx576Q6RH+VmplE4ncQV5v+5rzSoyOU7PuEAg8g803PwBJ0CExno/jcMbN8tONYeOmHiuUNryvm3fRUy4tMPVLdAGkUhNWuggGrJcXPv+ouCjz0MKUHz1J2/E8IC9nqTabcxgaBYM0hPhD5Y65FsbxRQKxCQrDjDctW7PUM3HuZunFyifSAqEfuzCp48Il24luWUWZoyJCaPR82jE0+kFA643wRFVni4RYSq3ohJO2pZ7B5dO4xkDWbEpossJPLSrPjYID8rS2UHTlvyNxqIGsg674XJJ7vnh5L7PNwC4hh2sjCI96mzszOTpxLF0T7l88Yz7lAuK6OnL8gXLOnTvpzSb22YG8W7us3jSebFHeeqnXRG1vt+MoUM84LQIBmMsCTAcOauTh0T0l0neQK7m2bLMt2mGxU3HYssS0J2cdv5wljlPsrIuZLAG/2DOZIXgCYT8uMGZN+e2kSirfxZOPCsC0f24nTZzspnVn9VePS1Z5vubmAGGXG8ZFno9Hel0yfA5ZPhF7Dh972BQJ2qCpgH67lmWtBYbvk6sz02wjky2vXyz0XErP/kFB619js1BtwfOV4OPRqOQBjy3Qbk18vigUPPSD5ceHnwck7W9bhAqZdd7SuG7w4/P2F/GaJh8c7e9qgow+Q7cGBo+98WsLkuktFqiZabtXuQTu/Y5ETbR0v7tNSFnvrmu6pjdoan2KjMu8q/Hmj1EfCO2ZGfEIbIXKUlw8qaX9/b2oeSJmFksSeT/Fn0V3nSypChh4Gjh74ybO9aeZ/AN2dwciu2/MhAAAAAElFTkSuQmCC">yolov5网络详解<!----></h1>  <div class="theme-vdoing-content content__default"><h1 id="_1-网络结构"><a href="#_1-网络结构" class="header-anchor">#</a> 1 网络结构</h1> <p>网络结构主要由以下几部分组成：</p> <ul><li><strong>Backbone</strong>: $\color{red}{New CSP-Darknet53}$</li> <li><strong>Neck</strong>: $\color{red}{SPPF, New CSP-PAN}$</li> <li><strong>Head</strong>: $\color{red}{YOLOv3 Head}$</li></ul> <p><img src="https://img-blog.csdnimg.cn/870b5d3ddd4245ada97160926ec1b2d6.png" alt="在这里插入图片描述"></p> <p>下面是根据<strong>yolov5l.yaml</strong>绘制的网络整体结构，YOLOv5针对不同大小**（n, s, m, l, x）<strong>的网络整体架构都是一样的，只不过会在每个子模块中采用不同的深度和宽度，分别应对yaml文件中的</strong>depth_multiple<strong>和</strong>width_multiple<strong>参数。还需要注意一点，官方除了</strong>n, s, m, l, x<strong>版本外还有</strong>n6, s6, m6, l6, x6**，区别在于后者是针对更大分辨率的图片比如<strong>1280x1280</strong>，当然结构上也有些差异，后者会下采样64倍，采用4个预测特征层，而前者只会下采样到32倍且采用3个预测特征层。本文只讨论前者。
<img src="https://img-blog.csdnimg.cn/528b42f73c5243f5aa3fa61d98983ee8.png#pic_center" alt="在这里插入图片描述"></p> <h2 id="_1-1-backbone"><a href="#_1-1-backbone" class="header-anchor">#</a> 1.1 Backbone</h2> <p>通过和YOLOv4对比，其实YOLOv5在Backbone部分没太大变化。但是YOLOv5在v6.0版本后相比之前版本有一个很小的改动，把网络的第一层（原来是Focus模块）换成了一个6x6大小的卷积层。两者在理论上其实等价的，但是对于现有的一些GPU设备（以及相应的优化算法）使用6x6大小的卷积层比使用Focus模块更加高效。详情可以参考这个issue #4825。下图是原来的Focus模块(和之前Swin Transformer中的Patch Merging类似)，将每个2x2的相邻像素划分为一个patch，然后将每个patch中相同位置（同一颜色）像素给拼在一起就得到了4个feature map，然后在接上一个3x3大小的卷积层。这和直接使用一个6x6大小的卷积层等效。</p> <h3 id="_1-focus结构"><a href="#_1-focus结构" class="header-anchor">#</a> （1）Focus结构</h3> <p><img src="https://img-blog.csdnimg.cn/d30a98fd986a4516b31f7d9af38a4291.png#pic_center" alt="在这里插入图片描述">
Focus结构，在Yolov3&amp;Yolov4中并没有这个结构，其中比较关键是切片操作。
比如右图的切片示意图，4<em>4</em>3的图像切片后变成2<em>2</em>12的特征图。
需要注意的是：Yolov5s的Focus结构最后使用了32个卷积核，而其他三种结构，使用的数量有所增加。</p> <h3 id="_2-new-csp-darknet53"><a href="#_2-new-csp-darknet53" class="header-anchor">#</a> （2）New CSP-Darknet53</h3> <p><img src="https://img-blog.csdnimg.cn/2909fff88793406eb3ba39b27850c781.png" alt="在这里插入图片描述">
而Yolov5中设计了两种CSP结构，以Yolov5s网络为例，应用于Backbone主干网络的CSP结构中Bottleneck模块<strong>用到</strong>了残差模块，应用于Neck中的CSP结构中Bottleneck模块则<strong>没有用到</strong>了残差模块。</p> <h2 id="_1-2-neck"><a href="#_1-2-neck" class="header-anchor">#</a> 1.2 Neck</h2> <h3 id="_1-fpn-pan"><a href="#_1-fpn-pan" class="header-anchor">#</a> （1）FPN+PAN</h3> <p><img src="https://img-blog.csdnimg.cn/76d62e7492e24456871f4961d9b7ac31.png" alt="在这里插入图片描述">
但如上面CSPNet结构中讲到，Yolov5和Yolov4的不同点在于，
Yolov4的Neck结构中，采用的都是普通的卷积操作。而Yolov5的Neck结构中，采用借鉴CSPnet设计的CSP结构（不用残差模块），加强网络特征融合的能力。
<img src="https://img-blog.csdnimg.cn/541c435588484975b21be12967338280.png" alt="在这里插入图片描述"></p> <h3 id="_2-sppf"><a href="#_2-sppf" class="header-anchor">#</a> （2）SPPF</h3> <p>将SPP换成成了SPPF（Glenn Jocher自己设计的），两者的作用是一样的，但后者效率更高。SPP结构如下图所示，是将输入并行通过多个不同大小的MaxPool，然后做进一步融合，能在一定程度上解决目标多尺度问题。
<img src="https://img-blog.csdnimg.cn/1922d547c3204af4998ed57bc026faad.png" alt="在这里插入图片描述">
而SPPF结构是将输入串行通过多个5x5大小的MaxPool层，这里需要注意的是串行两个5x5大小的MaxPool层是和一个9x9大小的MaxPool层计算结果是一样的，串行三个5x5大小的MaxPool层是和一个13x13大小的MaxPool层计算结果是一样的。
<img src="https://img-blog.csdnimg.cn/be6309e513f646e78d1f6eddeb60d0e1.png" alt="在这里插入图片描述">
下面做个简单的小实验，对比下SPP和SPPF的计算结果以及速度，代码如下（注意这里将SPPF中最开始和结尾处的1x1卷积层给去掉了，只对比含有MaxPool的部分）：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">import</span> time
<span class="token keyword">import</span> torch
<span class="token keyword">import</span> torch<span class="token punctuation">.</span>nn <span class="token keyword">as</span> nn


<span class="token keyword">class</span> <span class="token class-name">SPP</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>maxpool1 <span class="token operator">=</span> nn<span class="token punctuation">.</span>MaxPool2d<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>maxpool2 <span class="token operator">=</span> nn<span class="token punctuation">.</span>MaxPool2d<span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>maxpool3 <span class="token operator">=</span> nn<span class="token punctuation">.</span>MaxPool2d<span class="token punctuation">(</span><span class="token number">13</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token number">6</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        o1 <span class="token operator">=</span> self<span class="token punctuation">.</span>maxpool1<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        o2 <span class="token operator">=</span> self<span class="token punctuation">.</span>maxpool2<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        o3 <span class="token operator">=</span> self<span class="token punctuation">.</span>maxpool3<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        <span class="token keyword">return</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">[</span>x<span class="token punctuation">,</span> o1<span class="token punctuation">,</span> o2<span class="token punctuation">,</span> o3<span class="token punctuation">]</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>


<span class="token keyword">class</span> <span class="token class-name">SPPF</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>maxpool <span class="token operator">=</span> nn<span class="token punctuation">.</span>MaxPool2d<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        o1 <span class="token operator">=</span> self<span class="token punctuation">.</span>maxpool<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        o2 <span class="token operator">=</span> self<span class="token punctuation">.</span>maxpool<span class="token punctuation">(</span>o1<span class="token punctuation">)</span>
        o3 <span class="token operator">=</span> self<span class="token punctuation">.</span>maxpool<span class="token punctuation">(</span>o2<span class="token punctuation">)</span>
        <span class="token keyword">return</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">[</span>x<span class="token punctuation">,</span> o1<span class="token punctuation">,</span> o2<span class="token punctuation">,</span> o3<span class="token punctuation">]</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    input_tensor <span class="token operator">=</span> torch<span class="token punctuation">.</span>rand<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span>
    spp <span class="token operator">=</span> SPP<span class="token punctuation">(</span><span class="token punctuation">)</span>
    sppf <span class="token operator">=</span> SPPF<span class="token punctuation">(</span><span class="token punctuation">)</span>
    output1 <span class="token operator">=</span> spp<span class="token punctuation">(</span>input_tensor<span class="token punctuation">)</span>
    output2 <span class="token operator">=</span> sppf<span class="token punctuation">(</span>input_tensor<span class="token punctuation">)</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span>torch<span class="token punctuation">.</span>equal<span class="token punctuation">(</span>output1<span class="token punctuation">,</span> output2<span class="token punctuation">)</span><span class="token punctuation">)</span>

    t_start <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        spp<span class="token punctuation">(</span>input_tensor<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&quot;spp time: </span><span class="token interpolation"><span class="token punctuation">{</span>time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> t_start<span class="token punctuation">}</span></span><span class="token string">&quot;</span></span><span class="token punctuation">)</span>

    t_start <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        sppf<span class="token punctuation">(</span>input_tensor<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&quot;sppf time: </span><span class="token interpolation"><span class="token punctuation">{</span>time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> t_start<span class="token punctuation">}</span></span><span class="token string">&quot;</span></span><span class="token punctuation">)</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    main<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br></div></div><p>终端输出：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token boolean">True</span>
spp time<span class="token punctuation">:</span> <span class="token number">0.5373051166534424</span>
sppf time<span class="token punctuation">:</span> <span class="token number">0.20780706405639648</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>通过对比可以发现，两者的计算结果是一模一样的，但SPPF比SPP计算速度快了不止两倍，快乐翻倍。</p> <h2 id="_1-3-prediction"><a href="#_1-3-prediction" class="header-anchor">#</a> 1.3 Prediction</h2> <h3 id="_1-ciou-loss"><a href="#_1-ciou-loss" class="header-anchor">#</a> （1）CIOU_loss</h3> <p>目标检测任务的损失函数一般由Classificition Loss（分类损失函数）和Bounding Box Regeression Loss（回归损失函数）两部分构成。
Bounding Box Regeression的Loss近些年的发展过程是：Smooth L1 Loss-&gt; IoU Loss（2016）-&gt; GIoU Loss（2019）-&gt; DIoU Loss（2020）-&gt;CIoU Loss（2020）
我们从最常用的IOU_Loss开始，进行对比拆解分析，看下Yolov5为啥要选择CIOU_Loss。</p> <h4 id="a-iou-loss"><a href="#a-iou-loss" class="header-anchor">#</a> a.IOU_Loss</h4> <p><img src="https://img-blog.csdnimg.cn/0532aeae55e74aa790a1f3faf3fc16e8.png" alt="在这里插入图片描述">
可以看到IOU的loss其实很简单，主要是交集/并集，但其实也存在两个问题。
<img src="https://img-blog.csdnimg.cn/64659295f6d24500a2ec49ef2f3fa833.png" alt="在这里插入图片描述"> <strong>问题1</strong>：即状态1的情况，当预测框和目标框不相交时，IOU=0，无法反应两个框距离的远近，此时损失函数不可导，IOU_Loss无法优化两个框不相交的情况。
<strong>问题2</strong>：即状态2和状态3的情况，当两个预测框大小相同，两个IOU也相同，IOU_Loss无法区分两者相交情况的不同。
因此2019年出现了GIOU_Loss来进行改进。</p> <h4 id="b-giou-loss"><a href="#b-giou-loss" class="header-anchor">#</a> b.GIOU_Loss</h4> <p><img src="https://img-blog.csdnimg.cn/6d29f5aff3394a01b1514ee8c0270f1f.png" alt="在这里插入图片描述">
可以看到右图GIOU_Loss中，增加了相交尺度的衡量方式，缓解了单纯IOU_Loss时的尴尬。
但为什么仅仅说缓解呢？
因为还存在一种不足：
<img src="https://img-blog.csdnimg.cn/e0da9501e85d41299f9658e3c3c9dba4.png" alt="在这里插入图片描述"> <strong>问题</strong>：状态1、2、3都是预测框在目标框内部且预测框大小一致的情况，这时预测框和目标框的差集都是相同的，因此这三种状态的GIOU值也都是相同的，这时GIOU退化成了IOU，无法区分相对位置关系。
基于这个问题，2020年的AAAI又提出了DIOU_Loss。</p> <h4 id="c-diou-loss"><a href="#c-diou-loss" class="header-anchor">#</a> c.DIOU_Loss</h4> <p>好的目标框回归函数应该考虑三个重要几何因素：<strong>重叠面积、中心点距离，长宽比</strong>。</p> <p>针对IOU和GIOU存在的问题，作者从两个方面进行考虑
<strong>一：如何最小化预测框和目标框之间的归一化距离？</strong></p> <p><strong>二：如何在预测框和目标框重叠时，回归的更准确？</strong>
针对第一个问题，提出了DIOU_Loss（Distance_IOU_Loss）
<img src="https://img-blog.csdnimg.cn/eeffb0d8948f47a0b82d1b733afd65e2.png" alt="在这里插入图片描述">
但就像前面好的目标框回归函数所说的，没有考虑到长宽比。
<img src="https://img-blog.csdnimg.cn/8007e6f4161b4c438172d3f711b1db21.png" alt="在这里插入图片描述">
比如上面三种情况，目标框包裹预测框，本来DIOU_Loss可以起作用。
但预测框的中心点的位置都是一样的，因此按照DIOU_Loss的计算公式，三者的值都是相同的。
针对这个问题，又提出了CIOU_Loss，不对不说，科学总是在解决问题中，不断进步！！</p> <h4 id="d-ciou-loss"><a href="#d-ciou-loss" class="header-anchor">#</a> d.CIOU_Loss</h4> <p>CIOU_Loss和DIOU_Loss前面的公式都是一样的，不过在此基础上还增加了一个影响因子，将预测框和目标框的长宽比都考虑了进去。
<img src="https://img-blog.csdnimg.cn/599853124a34428b81ee4aa6b90983e4.png" alt="在这里插入图片描述">
其中v是衡量长宽比一致性的参数，我们也可以定义为：
<img src="https://img-blog.csdnimg.cn/ee1383d339074ce6aa36c5c83258145f.png" alt="在这里插入图片描述">
这样CIOU_Loss就将目标框回归函数应该考虑三个重要几何因素：重叠面积、中心点距离，长宽比全都考虑进去了。</p> <blockquote><p>再来综合的看下各个Loss函数的不同点：
<strong>IOU_Loss</strong>：主要考虑检测框和目标框重叠面积。
<strong>GIOU_Loss</strong>：在IOU的基础上，解决边界框不重合时的问题。
<strong>DIOU_Loss</strong>：在IOU和GIOU的基础上，考虑边界框中心点距离的信息。
<strong>CIOU_Loss</strong>：在DIOU的基础上，考虑边界框宽高比的尺度信息。
Yolov5中采用了<strong>CIOU_Loss</strong>的回归方式，使得预测框回归的速度和精度更高一些。</p></blockquote> <h3 id="_2-diou-nms"><a href="#_2-diou-nms" class="header-anchor">#</a> (2) DIOU_nms</h3> <p>在目标检测的后处理过程中，针对很多目标框的筛选，通常需要nms操作。
因为CIOU_Loss中包含影响因子v，涉及groudtruth的信息，而测试推理时，是没有groundtruth的。
所以Yolov4在DIOU_Loss的基础上采用DIOU_nms的方式，而Yolov5中采用加权nms的方式。
可以看出，采用DIOU_nms，下方中间箭头的黄色部分，原本被遮挡的摩托车也可以检出。
<img src="https://img-blog.csdnimg.cn/6b88ca9d16be4b5c9081a0abc0a99552.png" alt="在这里插入图片描述"></p> <h2 id="_2-数据增强"><a href="#_2-数据增强" class="header-anchor">#</a> 2 数据增强</h2> <h3 id="_1-对原图做数据增强"><a href="#_1-对原图做数据增强" class="header-anchor">#</a> 1. 对原图做数据增强</h3> <ul><li>像素级：HSV增强、旋转、缩放、平移、剪切、透视、翻转等</li> <li>图片级：MixUp、Cutout、CutMix、Mosaic、Copy-Paste(Segment)等</li></ul> <h3 id="_2-对标签做同样的增强"><a href="#_2-对标签做同样的增强" class="header-anchor">#</a> 2. 对标签做同样的增强</h3> <ul><li>变换后的坐标偏移量</li> <li>防止标签坐标越界</li></ul> <blockquote><p>Mosaic数据增强
Mosaic数据增强在YOLOv4就已经被使用，与<strong>CutMix</strong>有一定的相似性。<strong>Mosaic</strong>利用了四张图片，对四张图片进行随机拼接（<strong>随机缩放、随机裁剪、随机排布</strong>），每一张图片都有其对应的GT框，将四张图片拼接之后就获得一张新的图片，同时也获得这张图片对应的GT框，然后我们将这样一张新的图片传入到神经网络当中去训练，这样就极大地丰富了检测物体背景，并且在BN计算的时候会直接计算四张图片。
<img src="https://img-blog.csdnimg.cn/1e4eb78feb9e44c6938168fce07605dc.png" alt="在这里插入图片描述">
代码主要流程如下：</p> <ul><li>Step1：假设模型输入尺寸为s，首先初始化一幅尺寸为2s*2s的灰色大图</li> <li>Step2：在大图中从点A（s/2, s/2）和点B（3s/2, 3s/2）限定的矩形内随机选择一点作为拼接点</li> <li>Step3：随机选择四张图，取其部分拼入大图，超出的部分将被舍弃</li> <li>Step4：根据原图坐标的偏移量，重新计算GT框的坐标，并使用np.clip防止更新后的标签坐标越界</li></ul></blockquote> <h2 id="_3-输入端优化"><a href="#_3-输入端优化" class="header-anchor">#</a> 3 输入端优化</h2> <h3 id="_3-1自适应锚框计算"><a href="#_3-1自适应锚框计算" class="header-anchor">#</a> 3.1自适应锚框计算</h3> <p>在Yolo算法中，针对不同的数据集，都会有初始设定长宽的锚框。
在网络训练中，网络在初始锚框的基础上输出预测框，进而和真实框groundtruth进行比对，计算两者差距，再反向更新，迭代网络参数。
因此初始锚框也是比较重要的一部分，比如Yolov5在Coco数据集上初始设定的锚框：</p> <p>图片</p> <p>在Yolov3、Yolov4中，训练不同的数据集时，计算初始锚框的值是通过单独的程序运行的。
但Yolov5中将此功能嵌入到代码中，每次训练时，自适应的计算不同训练集中的最佳锚框值。
当然，如果觉得计算的锚框效果不是很好，也可以在代码中将自动计算锚框功能关闭。
<img src="https://img-blog.csdnimg.cn/87dadb6e4d0b45d9afe7a0f293f13b1d.png" alt="在这里插入图片描述">
控制的代码即train.py中上面一行代码，设置成False，每次训练时，不会自动计算。</p> <h3 id="_3-2自适应图片缩放"><a href="#_3-2自适应图片缩放" class="header-anchor">#</a> 3.2自适应图片缩放</h3> <p>在常用的目标检测算法中，不同的图片长宽都不相同，因此常用的方式是将原始图片统一缩放到一个标准尺寸，再送入检测网络中。
比如Yolo算法中常用416<em>416，608</em>608等尺寸，比如对下面800<em>600的图像进行缩放。
<img src="https://img-blog.csdnimg.cn/b1a4caec649449fbb0a3b532032c0182.png" alt="在这里插入图片描述">
但Yolov5代码中对此进行了改进，也是Yolov5推理速度能够很快的一个不错的trick。
作者认为，在项目实际使用时，很多图片的长宽比不同，因此缩放填充后，两端的黑边大小都不同，而如果填充的比较多，则存在信息冗余，影响推理速度。
因此在Yolov5的代码中datasets.py的letterbox函数中进行了修改，对原始图像自适应的添加最少的黑边。
<img src="https://img-blog.csdnimg.cn/0f410b08dd4745c49a301d12300b3854.png" alt="在这里插入图片描述">
图像高度上两端的黑边变少了，在推理时，计算量也会减少，即目标检测速度会得到提升。
在datasets.py的letterbox函数中有详细的代码。
第一步：计算缩放比例
<img src="https://img-blog.csdnimg.cn/92c1acf9534e4804b45c4e37f46b2625.png" alt="在这里插入图片描述">
原始缩放尺寸是416</em>416，都除以原始图像的尺寸后，可以得到0.52，和0.69两个缩放系数，选择小的缩放系数。
第二步：计算缩放后的尺寸
<img src="https://img-blog.csdnimg.cn/43c6cc2dcb4f415294b1435a2d4f05da.png" alt="在这里插入图片描述">
原始图片的长宽都乘以最小的缩放系数0.52，宽变成了416，而高变成了312。
第三步：计算黑边填充数值
<img src="https://img-blog.csdnimg.cn/0a03a72e422d4277b5480b5adadffe28.png" alt="在这里插入图片描述">
将416-312=104，得到原本需要填充的高度。再采用numpy中np.mod取余数的方式，得到8个像素，再除以2，即得到图片高度两端需要填充的数值。
此外，需要注意的是：</p> <p>a.这里大白填充的是黑色，即（0，0，0），而Yolov5中填充的是灰色，即（114,114,114），都是一样的效果。</p> <p>b.训练时没有采用缩减黑边的方式，还是采用传统填充的方式，即缩放到416*416大小。只是在测试，使用模型推理时，才采用缩减黑边的方式，提高目标检测，推理的速度。</p> <p>c.为什么np.mod函数的后面用32？因为Yolov5的网络经过5次下采样，而2的5次方，等于32。所以至少要去掉32的倍数，再进行取余。</p> <h2 id="_3-yolov5四种网络结构的不同点"><a href="#_3-yolov5四种网络结构的不同点" class="header-anchor">#</a> 3 Yolov5四种网络结构的不同点</h2> <p>Yolov5代码中的四种网络，和之前的Yolov3，Yolov4中的cfg文件不同，都是以yaml的形式来呈现。
而且四个文件的内容基本上都是一样的，只有最上方的depth_multiple和width_multiple两个参数不同，很多同学看的一脸懵逼，不知道只通过两个参数是如何控制四种结构的？</p> <h3 id="_3-1-四种结构的参数"><a href="#_3-1-四种结构的参数" class="header-anchor">#</a> 3.1 四种结构的参数</h3> <h4 id="_1-yolov5s-yaml"><a href="#_1-yolov5s-yaml" class="header-anchor">#</a> （1）Yolov5s.yaml</h4> <p><img src="https://img-blog.csdnimg.cn/acf03e5f765648f3b63a5600c3bf7363.png" alt="在这里插入图片描述"></p> <h4 id="_2-yolov5m-yaml"><a href="#_2-yolov5m-yaml" class="header-anchor">#</a> （2）Yolov5m.yaml</h4> <p><img src="https://img-blog.csdnimg.cn/c1c84154aa7147dcbb8fc5a7c3d9a5c2.png" alt="在这里插入图片描述"></p> <h4 id="_3-yolov5l-yaml"><a href="#_3-yolov5l-yaml" class="header-anchor">#</a> （3）Yolov5l.yaml</h4> <p><img src="https://img-blog.csdnimg.cn/dc43768675494f6eadb5b29e781424e7.png" alt="在这里插入图片描述"></p> <h4 id="_4-yolov5x-yaml"><a href="#_4-yolov5x-yaml" class="header-anchor">#</a> （4）Yolov5x.yaml</h4> <p><img src="https://img-blog.csdnimg.cn/88cc182822a545b38b65cc3d07a61a69.png" alt="在这里插入图片描述"></p> <blockquote><p>四种结构就是通过上面的两个参数，来进行控制网络的<strong>深度</strong>和<strong>宽度</strong>。其中<strong>depth_multiple</strong>控制网络的<strong>深度</strong>，<strong>width_multiple</strong>控制网络的<strong>宽度</strong>。</p></blockquote> <h3 id="_3-2-yolov5网络结构"><a href="#_3-2-yolov5网络结构" class="header-anchor">#</a> 3.2 Yolov5网络结构</h3> <p>四种结构的yaml文件中，下方的网络架构代码都是一样的。
为了便于讲解，将其中的Backbone部分提取出来，讲解如何控制网络的宽度和深度，yaml文件中的Head部分也是同样的原理。
<img src="https://img-blog.csdnimg.cn/4b598ede3a3243f7bd1db9878f3fef2a.png" alt="在这里插入图片描述">
在对网络结构进行解析时，yolo.py中下方的这一行代码将四种结构的depth_multiple，width_multiple提取出，赋值给gd，gw。后面主要对这gd，gw这两个参数进行讲解。
<img src="https://img-blog.csdnimg.cn/7d97a2bbc07c480381b26b925a0c2d84.png" alt="在这里插入图片描述">
下面再细致的剖析下，看是如何控制每种结构，深度和宽度的。</p> <h3 id="_3-3-yolov5四种网络的深度"><a href="#_3-3-yolov5四种网络的深度" class="header-anchor">#</a> 3.3 Yolov5四种网络的深度</h3> <p><img src="https://img-blog.csdnimg.cn/81f6264da5494232ae19732d798b4549.png" alt="在这里插入图片描述"></p> <h4 id="_1-不同网络的深度"><a href="#_1-不同网络的深度" class="header-anchor">#</a> （1）不同网络的深度</h4> <p>在上图中，有两种CSP结构，CSP1和CSP2，其中CSP1结构主要应用于Backbone中，CSP2结构主要应用于Neck中。
<strong>需要注意的是，四种网络结构中每个CSP结构的深度都是不同的。</strong></p> <ul><li>a.以yolov5s为例，第一个CSP1中，使用了1个残差组件，因此是<strong>CSP1_1</strong>。而在Yolov5m中，则增加了网络的深度，在第一个CSP1中，使用了2个残差组件，因此是<strong>CSP1_2</strong>。
而Yolov5l中，同样的位置，则使用了<strong>3个残差组件</strong>，Yolov5x中，使用了<strong>4个残差组件</strong>。
其余的第二个CSP1和第三个CSP1也是同样的原理。</li> <li>b.在第二种CSP2结构中也是同样的方式，以第一个CSP2结构为例，Yolov5s组件中使用了2×X=2×1=2个卷积，因为Ｘ=1，所以使用了1组卷积，因此是CSP2_1。
而Yolov5m中使用了<strong>2组</strong>，Yolov5l中使用了<strong>3组</strong>，Yolov5x中使用了<strong>4组</strong>。
其他的四个CSP2结构，也是同理。
Yolov5中，网络的不断加深，也在不断<strong>增加网络特征提取和特征融合的能力</strong>。</li></ul> <h4 id="_2-控制深度的代码"><a href="#_2-控制深度的代码" class="header-anchor">#</a> （2）控制深度的代码</h4> <p>控制四种网络结构的核心代码是<strong>yolo.py</strong>中下面的代码，存在两个变量，<strong>n</strong>和<strong>gd</strong>。
我们再将<strong>n</strong>和<strong>gd</strong>带入计算，看每种网络的变化结果。
<img src="https://img-blog.csdnimg.cn/329ec199ef9845258ea30c15710697dc.png" alt="在这里插入图片描述"></p> <h4 id="_3-验证控制深度的有效性"><a href="#_3-验证控制深度的有效性" class="header-anchor">#</a> （3）验证控制深度的有效性</h4> <p>我们选择最小的<strong>yolov5s.yaml</strong>和中间的<strong>yolov5l.yaml</strong>两个网络结构，将<strong>gd</strong>(<strong>depth_multiple</strong>)系数带入，看是否正确。
<img src="https://img-blog.csdnimg.cn/2783609ac8394a0a85892cda0ea8cf92.png" alt="在这里插入图片描述"></p> <h5 id="a-yolov5s-yaml"><a href="#a-yolov5s-yaml" class="header-anchor">#</a> a. yolov5s.yaml</h5> <p>其中<strong>depth_multiple=0.33</strong>，即<strong>gd=0.33</strong>，而<strong>n</strong>则由上面红色框中的信息获得。
以上面网络框图中的第一个CSP1为例，即上面的第一个红色框。<strong>n</strong>等于第二个数值3。
而<strong>gd=0.33</strong>，带入（2）中的计算代码，结果<strong>n=1</strong>。因此第一个CSP1结构内只有1个残差组件，即CSP1_1。
第二个CSP1结构中，n等于第二个数值9，而<strong>gd=0.33</strong>，带入（2）中计算，结果<strong>n=3</strong>，因此第二个CSP1结构中有3个残差组件，即CSP1_3。
第三个CSP1结构也是同理，这里不多说。</p> <h5 id="b-yolov5l-xml"><a href="#b-yolov5l-xml" class="header-anchor">#</a> b. yolov5l.xml</h5> <p>其中<strong>depth_multiple=1</strong>，即<strong>gd=1</strong>
和上面的计算方式相同，第一个CSP1结构中，n=3，带入代码中，结果n=3，因此为CSP1_3。
下面第二个CSP1和第三个CSP1结构都是同样的原理。</p> <h3 id="_3-4-yolov5四种网络的宽度"><a href="#_3-4-yolov5四种网络的宽度" class="header-anchor">#</a> 3.4 Yolov5四种网络的宽度</h3> <p><img src="https://img-blog.csdnimg.cn/d8ac6555246446fd856ec72c96e19a76.png" alt="在这里插入图片描述"></p> <h4 id="_1-不同网络的宽度"><a href="#_1-不同网络的宽度" class="header-anchor">#</a> （1）不同网络的宽度:</h4> <p>如上图表格中所示，四种yolov5结构在不同阶段的卷积核的数量都是不一样的，因此也直接影响卷积后特征图的第三维度，即<strong>厚度</strong>，这里表示为网络的<strong>宽度</strong>。</p> <ul><li>a.以Yolov5s结构为例，第一个Focus结构中，最后卷积操作时，卷积核的数量是<strong>32</strong>个，因此经过Focus结构，特征图的大小变成<strong>304 * 304 * 32</strong>。
而yolov5m的Focus结构中的卷积操作使用了48个卷积核，因此Focus结构后的特征图变成<strong>304* 304*48</strong>。yolov5l，yolov5x也是同样的原理。</li> <li>b. 第二个卷积操作时，yolov5s使用了64个卷积核，因此得到的特征图是<strong>152 * 152 * 64</strong>。而yolov5m使用96个特征图，因此得到的特征图是<strong>152* 152*96</strong>。yolov5l，yolov5x也是同理。</li> <li>c. 后面三个卷积下采样操作也是同样的原理。</li></ul> <p>四种不同结构的卷积核的数量不同，这也直接影响网络中，比如CSP1，CSP2等结构，以及各个普通卷积，卷积操作时的卷积核数量也同步在调整，影响整体网络的计算量。
当然卷积核的数量越多，特征图的厚度，即<strong>宽度越宽</strong>，网络提取特征的学习能力也越强。</p> <h4 id="_2-控制宽度的代码"><a href="#_2-控制宽度的代码" class="header-anchor">#</a> （2）控制宽度的代码</h4> <p>在yolov5的代码中，控制宽度的核心代码是<strong>yolo.py</strong>文件里面的这一行：
<img src="https://img-blog.csdnimg.cn/110b5284595b4e1d85d370d1edd799c7.png" alt="在这里插入图片描述"></p> <h4 id="_3-验证控制宽度的有效性"><a href="#_3-验证控制宽度的有效性" class="header-anchor">#</a> （3）验证控制宽度的有效性</h4> <p>我们还是选择<strong>最小的yolov5s</strong>和<strong>中间的yolov5l</strong>两个网络结构，将width_multiple系数带入，看是否正确。
<img src="https://img-blog.csdnimg.cn/d1f6e24d55a1465ab02139dd73d699ee.png" alt="在这里插入图片描述"></p> <h4 id="a-yolov5s-yaml-2"><a href="#a-yolov5s-yaml-2" class="header-anchor">#</a> a. yolov5s.yaml</h4> <p>其中<strong>width_multiple=0.5</strong>，即<strong>gw=0.5</strong>。
<img src="https://img-blog.csdnimg.cn/8b6519bbbb174f858ea94228b097ab6f.png" alt="在这里插入图片描述"></p> <p>以第一个卷积下采样为例，即Focus结构中下面的卷积操作。
按照上面Backbone的信息，我们知道Focus中，标准的c2=64，而<strong>gw=0.5</strong>，代入（2）中的计算公式，最后的结果**=32**。即Yolov5s的Focus结构中，卷积下采样操作的卷积核数量为<strong>32个</strong>。
再计算后面的第二个卷积下采样操作，标准c2的值=128，<strong>gw=0.5</strong>，代入（2）中公式，最后的结果**=64**，也是正确的。</p> <h4 id="b-yolov5l-yaml"><a href="#b-yolov5l-yaml" class="header-anchor">#</a> b. yolov5l.yaml</h4> <p>其中<strong>width_multiple=1</strong>，即<strong>gw=1</strong>，而标准的<strong>c2=64</strong>，代入上面（2）的计算公式中，可以得到Yolov5l的Focus结构中，卷积下采样操作的卷积核的数量为<strong>64个</strong>，而第二个卷积下采样的卷积核数量是<strong>128个</strong>。
另外的三个卷积下采样操作，以及yolov5m，yolov5x结构也是同样的计算方式。</p> <h2 id="参考"><a href="#参考" class="header-anchor">#</a> 参考：</h2> <p>https://blog.csdn.net/weixin_43799388/article/details/123830587
https://zhuanlan.zhihu.com/p/172121380</p></div></div>  <div class="page-edit"><div class="edit-link"><a href="https://github.com/my-monster/blog/edit/master/docs/02.学习笔记/06.yolov5学习/06.yolov5网络详解.md" target="_blank" rel="noopener noreferrer">编辑</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2023/03/13, 16:17:24</span></div></div> <div class="page-nav-wapper"><div class="page-nav-centre-wrap"><a href="/pages/b544fb/" class="page-nav-centre page-nav-centre-prev"><div class="tooltip">yolov5-源码数据处理解析</div></a> <a href="/pages/792f95/" class="page-nav-centre page-nav-centre-next"><div class="tooltip">python 装饰器详解</div></a></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/pages/b544fb/" class="prev">yolov5-源码数据处理解析</a></span> <span class="next"><a href="/pages/792f95/">python 装饰器详解</a>→
      </span></p></div></div></div> <div class="article-list"><div class="article-title"><a href="/archives/" class="iconfont icon-bi">最近更新</a></div> <div class="article-wrapper"><dl><dd>01</dd> <dt><a href="/pages/e0fcae/"><div>
            为什么深度学习去噪都采用高斯白噪声？
            <!----></div></a> <span class="date">03-13</span></dt></dl><dl><dd>02</dd> <dt><a href="/pages/cf75c3/"><div>
            深度学习在图像去噪方面最近有哪些进展，与传统方法相比效果如何？
            <!----></div></a> <span class="date">03-13</span></dt></dl><dl><dd>03</dd> <dt><a href="/pages/650608/"><div>
            训练时的学习率调整：optimizer和scheduler - 知乎
            <!----></div></a> <span class="date">03-13</span></dt></dl> <dl><dd></dd> <dt><a href="/archives/" class="more">更多文章&gt;</a></dt></dl></div></div></main></div> <div class="footer"><div class="icons"><a href="mailto:1335844747@qq.com" title="发邮件" target="_blank" class="iconfont icon-youjian"></a><a href="https://github.com/my-monster" title="GitHub" target="_blank" class="iconfont icon-github"></a><a href="https://music.163.com/#/playlist?id=463807063" title="听音乐" target="_blank" class="iconfont icon-erji"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2022-2023
    <span>Evan Xu | <a href="https://github.com/my-monster" target="_blank">MIT License</a></span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"><div></div></div></div>
    <script src="/assets/js/app.50fadf31.js" defer></script><script src="/assets/js/2.47a03fa1.js" defer></script><script src="/assets/js/3.436c0527.js" defer></script><script src="/assets/js/41.0b9b9a66.js" defer></script>
  </body>
</html>
